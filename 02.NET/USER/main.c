#include "git.h"


// 软件定时器设定
static Timer task1_id;
static Timer task2_id;
static Timer task3_id;
extern u8 time25ms;

// 获取全局变量
const char *topics[] = {S_TOPIC_NAME};

// 硬件初始化
void Hardware_Init(void)
{
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); // 设置中断优先级分组为组2：2位抢占优先级，2位响应优先级

    delay_init();                                   // 延时函数初始化
    GENERAL_TIM_Init(TIM_4, 0, 1);
   
    while (Reset_Threshole_Value(&threshold_value_init, &device_state_init) != MY_SUCCESSFUL)
        delay_ms(5); // 初始化阈值
  

}
// 网络初始化
void Net_Init()
{

#if OLED // OLED文件存在
    // 写OLED内容
		LCD1602_Show_Str(2, 0, "WIFI  ... ");
		LCD1602_Show_Str(2, 1, "COUNT ...");
#endif
    ESP8266_Init();          // 初始化ESP8266
   
		
		LCD1602_ClearScreen(); // 清屏
}

// 任务1
void task1(void)
{
	//1秒计算器
 	Automation_Close();
	Update_oled_massage();   // 更新OLED
	
}
// 任务2
void task2(void)
{
// 设备重连
#if NETWORK_CHAEK
    if (Connect_Net == 0) {
			
#if OLED // OLED文件存在
		LCD1602_Show_Str(2, 0, "WIFI  ... ");
		LCD1602_Show_Str(2, 1, "COUNT ...");
#endif
        ESP8266_Init();          // 初始化ESP8266
        while (DevLink()) // 接入OneNET
            delay_ms(300);
        while (Subscribe(topics, 1)) // 订阅主题
            delay_ms(300);
        Connect_Net = 60; // 入网成功
    }
#endif

    Read_Data(&Data_init);   // 更新传感器数据
   
    Update_device_massage(); // 更新设备
                             // BEEP= ~BEEP;
    State = ~State;
}
// 任务3
void task3(void)
{
   if (Connect_Net && Data_init.App == 0) {
        //Data_init.App = 1;
   }
}
// 软件初始化
void SoftWare_Init(void)
{
    // 定时器初始化
    timer_init(&task1_id, task1, 1000, 1); // 1s执行一次
    timer_init(&task2_id, task2, 60, 1);  // 100ms执行一次
    timer_init(&task3_id, task3, 4000, 1); // 2.5s执行一次
 
}
// 主函数
int main(void)
{

    unsigned char *dataPtr = NULL;
    SoftWare_Init(); // 软件初始化
    Hardware_Init(); // 硬件初始化

    Net_Init(); // 网络初始
    TIM_Cmd(TIM4, ENABLE); // 使能计数器
	
		Get_Maopi(); // 归零
    delay_ms(1000);
    Get_Maopi(); // 归零
    while (1) {

        // 线程
        timer_loop(); // 定时器执行
        // 串口接收判断
        dataPtr = ESP8266_GetIPD(0);
     
    }
}

